<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MEP Login</title>
  <style>
    body {
      background-color: #1a1b26;
      color: #f4d9e1;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
    }
    .section {
      background-color: #2b2d40;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 0 10px rgba(244, 217, 225, 0.15);
    }
    h2 {
      font-size: 1.4em;
      margin-bottom: 10px;
      color: #f4d9e1;
    }
    input, textarea {
      width: 100%;
      background-color: #3a3c58;
      color: #f4d9e1;
      border: 1px solid #4e5174;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 6px;
    }
    textarea {
      min-height: 100px;
    }
    button {
      background-color: #c574dd;
      color: #1a1b26;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #df94ee;
    }
    .delete-btn {
      background-color: #ff89b5;
      padding: 5px 12px;
      border: none;
      border-radius: 4px;
      margin-top: 5px;
      cursor: pointer;
    }
    .recipe-content ul {
      list-style-type: disc;
      padding-left: 20px;
    }
    .recipe, .cleaning-task {
      background-color: #3a3c58;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 6px;
    }
    .hidden {
      display: none;
    }
    #quote-box {
      background-color: #24283b;
      color: #f4d9e1;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 20px;
      font-style: italic;
      font-size: 1.1em;
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.05);
    }
    @media (max-width: 600px) {
      body { padding: 10px; }
      .section { padding: 15px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="auth-section" class="section">
      <h2>MEP Login / Register</h2>
      <input type="text" id="username" placeholder="Username">
      <input type="password" id="password" placeholder="Password">
      <input type="text" id="accessKey" placeholder="Access Key (for register only)">
      <input type="text" id="stationInput" placeholder="Station (for register only)">
      <button onclick="register()">Register</button>
      <button onclick="login()">Login</button>
    </div>

    <div id="app-section" class="hidden">
      <div id="quote-box">"Loading inspiration..."</div>

      <div class="section">
        <h2>Whiteboard: Today & Tomorrow's Prep</h2>
        <form id="whiteboard-form">
          <textarea id="todayPrep" placeholder="Today’s Prep"></textarea>
          <textarea id="tomorrowPrep" placeholder="Tomorrow’s Prep"></textarea>
          <button type="submit">Save Whiteboard</button>
        </form>
      </div>

      <div class="section">
        <h2>MEP: Add Recipe</h2>
        <form id="recipe-form">
          <input type="text" id="recipeName" placeholder="Recipe name">
          <textarea id="steps" placeholder="Steps (one per line, use * for bullets, ### for sections)"></textarea>
          <input type="text" id="station" placeholder="Station (e.g., Prep)" readonly>
          <button type="submit">Submit</button>
        </form>
        <div id="response"></div>
      </div>

      <div class="section">
        <h2>Saved Recipes</h2>
        <div id="savedRecipes"></div>
      </div>

      <div class="section">
        <h2>Add Cleaning Task</h2>
        <form id="cleaning-form">
          <input type="text" id="task" placeholder="Cleaning task (e.g., sanitize slicer)">
          <input type="text" id="assignedTo" placeholder="Assigned to (e.g., PJ)">
          <button type="submit">Save Cleaning Task</button>
        </form>
      </div>

      <div class="section">
        <h2>Cleaning Tasks</h2>
        <div id="cleaningTasks"></div>
      </div>

      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <script>
    const BASE_URL = 'https://mep-api-7pph.onrender.com';
    let token = localStorage.getItem('token');
    let station = localStorage.getItem('station');

    if (token) {
      showApp();
      document.getElementById('station').value = station || 'Prep';
      loadWhiteboard();
      loadRecipes();
      loadCleaningTasks();
    }

    document.getElementById('whiteboard-form').addEventListener('submit', saveWhiteboard);
    document.getElementById('recipe-form').addEventListener('submit', addRecipe);
    document.getElementById('cleaning-form').addEventListener('submit', addCleaningTask);

    function showApp() {
      document.getElementById('auth-section').classList.add('hidden');
      document.getElementById('app-section').classList.remove('hidden');
      showQuote();
    }

    async function register() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const accessKey = document.getElementById('accessKey').value;
      const stationInput = document.getElementById('stationInput').value;

      try {
        const res = await fetch(`${BASE_URL}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, accessKey, station: stationInput })
        });
        const data = await res.json();
        alert(data.message);
      } catch (err) {
        alert('Registration failed: ' + err.message);
      }
    }

    async function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        const res = await fetch(`${BASE_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (res.ok) {
          localStorage.setItem('token', data.token);
          localStorage.setItem('station', data.station || 'Prep');
          token = data.token;
          station = data.station || 'Prep';
          showApp();
          document.getElementById('station').value = station;
          loadWhiteboard();
          loadRecipes();
          loadCleaningTasks();
        } else {
          alert(data.message || 'Login failed');
        }
      } catch (err) {
        alert('Login failed: ' + err.message);
      }
    }

    function logout() {
      localStorage.clear();
      window.location.reload();
    }

    async function saveWhiteboard(e) {
      e.preventDefault();
      const todayPrep = document.getElementById('todayPrep').value;
      const tomorrowPrep = document.getElementById('tomorrowPrep').value;

      try {
        const res = await fetch(`${BASE_URL}/whiteboard`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ todayPrep, tomorrowPrep })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Save failed');
        alert(data.message);
      } catch (err) {
        alert('Save whiteboard failed: ' + err.message);
      }
    }

    async function loadWhiteboard() {
      try {
        const res = await fetch(`${BASE_URL}/whiteboard`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        document.getElementById('todayPrep').value = data.todayPrep || '';
        document.getElementById('tomorrowPrep').value = data.tomorrowPrep || '';
      } catch (err) {
        alert('Load whiteboard failed: ' + err.message);
      }
    }

    async function addRecipe(e) {
      e.preventDefault();
      const name = document.getElementById('recipeName').value;
      const steps = document.getElementById('steps').value;
      const stationVal = document.getElementById('station').value || 'Prep';

      try {
        const res = await fetch(`${BASE_URL}/recipes`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ name, steps, station: stationVal })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Add failed');
        document.getElementById('response').innerText = `✅ ${data.message}`;
        document.getElementById('recipe-form').reset();
        loadRecipes();
      } catch (err) {
        document.getElementById('response').innerText = '❌ Add recipe failed: ' + err.message;
      }
    }

    async function loadRecipes() {
      try {
        const res = await fetch(`${BASE_URL}/recipes`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const recipes = await res.json();
        const container = document.getElementById('savedRecipes');
        container.innerHTML = '';
        recipes.forEach(r => {
          const div = document.createElement('div');
          div.className = 'recipe';
          div.innerHTML = `
            <h3>${r.name}</h3>
            <div class="recipe-content">${parseMarkdown(r.steps)}</div>
            <p>Station: ${r.station || 'Not set'}</p>
            <button class="delete-btn" onclick="deleteRecipe('${r._id}')">Delete</button>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        alert('Load recipes failed: ' + err.message);
      }
    }

    async function deleteRecipe(id) {
      try {
        const res = await fetch(`${BASE_URL}/recipes/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Delete failed');
        alert(data.message);
        loadRecipes();
      } catch (err) {
        alert('Delete recipe failed: ' + err.message);
      }
    }

    async function addCleaningTask(e) {
      e.preventDefault();
      const task = document.getElementById('task').value;
      const assignedTo = document.getElementById('assignedTo').value;

      try {
        const res = await fetch(`${BASE_URL}/cleaning`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ task, assignedTo })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Add failed');
        document.getElementById('cleaning-form').reset();
        loadCleaningTasks();
        alert('✅ Cleaning task saved');
      } catch (err) {
        alert('Add task failed: ' + err.message);
      }
    }

    async function loadCleaningTasks() {
      try {
        const res = await fetch(`${BASE_URL}/cleaning`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const tasks = await res.json();
        const container = document.getElementById('cleaningTasks');
        container.innerHTML = '';
        tasks.forEach(t => {
          const div = document.createElement('div');
          div.className = 'cleaning-task';
          div.innerHTML = `
            <h3>${t.task}</h3>
            <p>Assigned to: ${t.assignedTo}</p>
            <button class="delete-btn" onclick="deleteCleaningTask('${t._id}')">Delete</button>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        alert('Load tasks failed: ' + err.message);
      }
    }

    async function deleteCleaningTask(id) {
      try {
        const res = await fetch(`${BASE_URL}/cleaning/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Delete failed');
        alert(data.message);
        loadCleaningTasks();
      } catch (err) {
        alert('Delete task failed: ' + err.message);
      }
    }

    function parseMarkdown(text) {
      return text
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^\* (.*$)/gm, '<li>$1</li>')
        .replace(/\n/g, '<br>');
    }

    function showQuote() {
      const quotes = [
        "“Yes, chef.” — every kitchen, everywhere",
        "“The only way to learn to cook is to cook.” — Ferran Adrià",
        "“A recipe has no soul. You must bring soul to the recipe.” — Thomas Keller",
        "“Clean as you go.” — Every line cook's mantra",
        "“Stay sharp, stay kind.” — johnE.ai",
        "“The prep list is your prayer.” — MEP Philosophy"
      ];
      document.getElementById('quote-box').textContent = 
        quotes[Math.floor(Math.random() * quotes.length)];
    }

    // Login/Register field toggle behavior
    document.getElementById('accessKey').style.display = 'none';
    document.getElementById('stationInput').style.display = 'none';
    document.querySelector('button[onclick="register()"]').addEventListener('click', () => {
      document.getElementById('accessKey').style.display = 'block';
      document.getElementById('stationInput').style.display = 'block';
    });
    document.querySelector('button[onclick="login()"]').addEventListener('click', () => {
      document.getElementById('accessKey').style.display = 'none';
      document.getElementById('stationInput').style.display = 'none';
    });
  </script>
</body>
</html>
